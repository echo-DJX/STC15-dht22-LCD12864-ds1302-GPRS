C51 COMPILER V9.02   DHT22                                                                 09/27/2019 09:57:40 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE DHT22
OBJECT MODULE PLACED IN dht22.OBJ
COMPILER INVOKED BY: F:\Keil\C51\BIN\C51.EXE dht22.c LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include "bsp.h"
   2          
   3          extern unsigned char  RH_DATA[];
   4          
   5          void Delay10us(void)            //@11.0592MHz
   6          {
   7   1              unsigned char i;
   8   1      
   9   1              _nop_();
  10   1              i = 25;
  11   1              while (--i);
  12   1      }
  13          
  14          
  15          u8  DHT11_COM(void)
  16           {
  17   1           u8 i;
  18   1          u8  U8temp,U8comdata;
  19   1              U8comdata=0;
  20   1             for(i=0;i<8;i++)    
  21   1                  {
  22   2                      while(!DHT11_DAT);
  23   2                           Delay10us();
  24   2                             Delay10us();
  25   2                             Delay10us();
  26   2                             Delay10us();      //延时40us，读数
  27   2                              U8temp=0;
  28   2                      if(DHT11_DAT) U8temp=1;
  29   2                      while(DHT11_DAT);
  30   2                      
  31   2                         U8comdata<<=1;
  32   2                         U8comdata+=U8temp;        //0
  33   2                   }//rof
  34   1              return  U8comdata;
  35   1      }
  36          
  37                  //--------------------------------
  38                  //-----湿度读取子程序 ------------
  39                  //--------------------------------
  40                  //----以下变量均为全局变量--------
  41                  //----温度高8位== U8T_data_H------
  42                  //----温度低8位== U8T_data_L------
  43                  //----湿度高8位== U8RH_data_H-----
  44                  //----湿度低8位== U8RH_data_L-----
  45                  //----校验 8位 == U8checkdata-----
  46                  //----调用相关子程序如下----------
  47                  //---- Delay();, Delay10us();,DHT11_COM(); 
  48                  //--------------------------------
  49          u8 check(void)
  50          { u8  FLAG;
  51   1                FLAG=2;
  52   1               while((!DHT11_DAT)&&(FLAG++));
  53   1                if(FLAG==1)
  54   1                     return 0;
  55   1                else
C51 COMPILER V9.02   DHT22                                                                 09/27/2019 09:57:40 PAGE 2   

  56   1                {   FLAG=2; 
  57   2                     while((DHT11_DAT)&&(FLAG++));
  58   2                     if(FLAG==1)
  59   2                           return 0;
  60   2                     else
  61   2                           return 1;
  62   2                }
  63   1      }
  64          void RH_SEND(void)
  65          {
  66   1              u8  U8temp1;
  67   1              uint  tmp,tmp1,tmp2,tmp3,tmp4;   
  68   1         u8  U8T_data_H_temp,U8T_data_L_temp,U8RH_data_H_temp,U8RH_data_L_temp,U8checkdata_temp;        
  69   1       //主机拉低18ms以上 
  70   1                  DHT11_DAT=1;
  71   1                 Delay10us();
  72   1                 DHT11_DAT=0;
  73   1                 DelayXms(20);
  74   1                DHT11_DAT=1;
  75   1               //总线由上拉电阻拉高 主机延时20us-40us
  76   1                 Delay10us();
  77   1                 Delay10us();
  78   1                 Delay10us();
  79   1               //主机设为输入 判断从机响应信号 
  80   1            if(check()==1)
  81   1            {  
  82   2               //数据接收状态          
  83   2                 U8RH_data_H_temp=DHT11_COM();
  84   2                 U8RH_data_L_temp=DHT11_COM();
  85   2                 U8T_data_H_temp=DHT11_COM();
  86   2                 U8T_data_L_temp=DHT11_COM();
  87   2                 U8checkdata_temp=DHT11_COM();
  88   2                 DHT11_DAT=1;
  89   2               //数据校验 
  90   2               
  91   2                U8temp1=(U8T_data_H_temp+U8T_data_L_temp+U8RH_data_H_temp+U8RH_data_L_temp);
  92   2                if(U8temp1==U8checkdata_temp)
  93   2                {
  94   3                        RH_DATA[0]=U8RH_data_H_temp;    //湿度整数
  95   3                        RH_DATA[1]=U8RH_data_L_temp;    //湿度小数
  96   3                        RH_DATA[2]=U8T_data_H_temp;      //温度整数
  97   3                        RH_DATA[3]=U8T_data_L_temp;      //温度小数
  98   3                        RH_DATA[4]=U8checkdata_temp;    //校验码
  99   3                }
 100   2             }  
 101   1             else
 102   1              {
 103   2                        PutStr(2,0,"DHT22无响应");
 104   2               }
 105   1      
 106   1               tmp=RH_DATA[0]*256+RH_DATA[1];
 107   1               tmp1=tmp/10;
 108   1               tmp2=tmp%10;
 109   1               if(RH_DATA[2]<128)
 110   1               {
 111   2                 tmp=RH_DATA[2]*256+RH_DATA[3];
 112   2                 tmp3=tmp/10;
 113   2                 tmp4=tmp%10;
 114   2                 sprintf(SEND_HT,"{\"temperature\":%2d.%1d%,\"humidity\":%2d.%1d}\r\n",tmp3,tmp4,tmp1,tmp2);
 115   2               }                                 
 116   1               else
 117   1               {
C51 COMPILER V9.02   DHT22                                                                 09/27/2019 09:57:40 PAGE 3   

 118   2                 tmp=(RH_DATA[2]-128)*256+RH_DATA[3];
 119   2                 tmp3=tmp/10;
 120   2                 tmp4=tmp%10;
 121   2                 sprintf(SEND_HT,"{\"humidity\":%2d.%1d%,\"temperature\":-%2d.%1d}\r\n",tmp1,tmp2,tmp3,tmp4); 
 122   2               }
 123   1               Delay1ms();
 124   1      }
 125          void RH(void)
 126          {
 127   1         u8  U8temp1;
 128   1              uint  tmp,tmp1,tmp2,tmp3,tmp4;   
 129   1         u8  U8T_data_H_temp,U8T_data_L_temp,U8RH_data_H_temp,U8RH_data_L_temp,U8checkdata_temp;        
 130   1       //主机拉低18ms以上 
 131   1                  DHT11_DAT=1;
 132   1                 Delay10us();
 133   1                 DHT11_DAT=0;
 134   1                 DelayXms(20);
 135   1                DHT11_DAT=1;
 136   1               //总线由上拉电阻拉高 主机延时20us-40us
 137   1                 Delay10us();
 138   1                 Delay10us();
 139   1                 Delay10us();
 140   1               //主机设为输入 判断从机响应信号 
 141   1            if(check()==1)
 142   1            {  
 143   2               //数据接收状态          
 144   2                 U8RH_data_H_temp=DHT11_COM();
 145   2                 U8RH_data_L_temp=DHT11_COM();
 146   2                 U8T_data_H_temp=DHT11_COM();
 147   2                 U8T_data_L_temp=DHT11_COM();
 148   2                 U8checkdata_temp=DHT11_COM();
 149   2                 DHT11_DAT=1;
 150   2               //数据校验 
 151   2               
 152   2                U8temp1=(U8T_data_H_temp+U8T_data_L_temp+U8RH_data_H_temp+U8RH_data_L_temp);
 153   2                if(U8temp1==U8checkdata_temp)
 154   2                {
 155   3                        RH_DATA[0]=U8RH_data_H_temp;    //湿度整数
 156   3                        RH_DATA[1]=U8RH_data_L_temp;    //湿度小数
 157   3                        RH_DATA[2]=U8T_data_H_temp;      //温度整数
 158   3                        RH_DATA[3]=U8T_data_L_temp;      //温度小数
 159   3                        RH_DATA[4]=U8checkdata_temp;    //校验码
 160   3                }
 161   2             }  
 162   1             else
 163   1              {
 164   2                      //  PutStr(2,0,"DHT22无响应");
 165   2               }
 166   1      
 167   1               tmp=RH_DATA[0]*256+RH_DATA[1];
 168   1               tmp1=tmp/10;
 169   1               tmp2=tmp%10;
 170   1               if(RH_DATA[2]<128)
 171   1               {
 172   2                 tmp=RH_DATA[2]*256+RH_DATA[3];
 173   2                 tmp3=tmp/10;
 174   2                 tmp4=tmp%10;
 175   2                 sprintf(SHOW_HT,"H=%2d.%1d%% T=%2d.%1dC",tmp1,tmp2,tmp3,tmp4);
 176   2               }                                 
 177   1               else
 178   1               {
 179   2                 tmp=(RH_DATA[2]-128)*256+RH_DATA[3];
C51 COMPILER V9.02   DHT22                                                                 09/27/2019 09:57:40 PAGE 4   

 180   2                 tmp3=tmp/10;
 181   2                 tmp4=tmp%10;
 182   2                 sprintf(SHOW_HT,"H=%2d.%1d% T=-%2d.%1d",tmp1,tmp2,tmp3,tmp4);
 183   2               }
 184   1               Delay1ms();
 185   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    882    ----
   CONSTANT SIZE    =    150    ----
   XDATA SIZE       =   ----      22
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
