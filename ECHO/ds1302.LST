C51 COMPILER V9.02   DS1302                                                                09/27/2019 09:57:41 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN ds1302.OBJ
COMPILER INVOKED BY: F:\Keil\C51\BIN\C51.EXE ds1302.c LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          //===============================头文件调用===========================//
   2          #include "bsp.h"
   3          uint xdata hour,min,sec;
   4          uint xdata year,month,day;
   5          //char idata timenow[7]={0x00,0x00,0x12,0x01,0x06,0x03,0x10};//"秒-分-时-日-月-星期-年"寄存器初始值
   6          char timenow[7];
   7          //uint xdata hour,min,sec;
   8          //uint xdata year,month,day;
   9          //==================实时时钟模块 时钟芯片型号：DS1302==================//
  10          //=====================================================================//
  11          //      语法格式：      void DS1302_WriteByte(uchar ucDa)
  12          //      实现功能：      往DS1302写入1Byte数据
  13          //      参数：          uchar ucDa――写入的数据
  14          //      返回值：        无
  15          //=====================================================================//
  16          void DS1302_WriteByte(uchar ucDa)               
  17          { 
  18   1              uchar i,temp;
  19   1              temp=ucDa; 
  20   1              for(i=0;i<8;i++)
  21   1              {
  22   2                      T_CLK=0;
  23   2                      DelayXus(2);
  24   2                      temp>>=1;
  25   2                      T_IO=CY;
  26   2                      _nop_();
  27   2                      T_CLK=1;
  28   2                      DelayXus(2);
  29   2              } 
  30   1      }
  31          
  32          //=====================================================================//
  33          //      语法格式：      uchar DS1302_ReadByte(void) 
  34          //      实现功能：      从DS1302读取1Byte数据
  35          //      参数：          无
  36          //      返回值：        uchar temp
  37          //=====================================================================//
  38          uchar DS1302_ReadByte(void) 
  39          { 
  40   1              uchar i,temp;
  41   1              temp=0;
  42   1              for(i=0;i<8;i++)
  43   1              {
  44   2                      T_CLK=0;
  45   2                      DelayXus(2);
  46   2                      temp>>=1;
  47   2                      if(T_IO)
  48   2                         temp|=0x80;
  49   2                      T_CLK=1;
  50   2                      DelayXus(2);
  51   2              } 
  52   1              return(temp); 
  53   1      }
  54          
  55          //=====================================================================//
C51 COMPILER V9.02   DS1302                                                                09/27/2019 09:57:41 PAGE 2   

  56          //      语法格式：      void DS1302_W1302(uchar ucAddr, uchar ucDa) 
  57          //      实现功能：      往DS1302写入数据（先写地址，后写命令/数据）
  58          //      参数：          uchar ucAddr――DS1302地址，ucDa――要写的数据
  59          //      返回值：        无
  60          //=====================================================================//
  61          void DS1302_W1302(uchar ucAddr, uchar ucDa)
  62          {
  63   1              T_RST=0;
  64   1              DelayXus(1);
  65   1              T_CLK=0;
  66   1              DelayXus(1);
  67   1              T_RST=1;
  68   1              DelayXus(2);
  69   1              DS1302_WriteByte(ucAddr); 
  70   1              DS1302_WriteByte(ucDa); 
  71   1              T_CLK=1;
  72   1              DelayXus(1);
  73   1              T_RST=0;
  74   1              DelayXus(1);
  75   1      } 
  76          
  77          //=====================================================================//
  78          //      语法格式：      uchar DS1302_R1302(uchar ucAddr) 
  79          //      实现功能：      读取DS1302地址的数据（先写地址，后读命令/数据）
  80          //      参数：          uchar ucAddr――DS1302地址
  81          //      返回值：        uchar ucDa
  82          //=====================================================================//
  83          uchar DS1302_R1302(uchar ucAddr)
  84          {
  85   1              uchar ucDa;
  86   1              T_RST = 0;
  87   1              DelayXus(1);
  88   1              T_CLK = 0;
  89   1              DelayXus(1);
  90   1              T_RST = 1;
  91   1              DelayXus(2);
  92   1              DS1302_WriteByte(ucAddr); 
  93   1              ucDa = DS1302_ReadByte(); 
  94   1              T_CLK = 1;
  95   1              DelayXus(1);
  96   1              T_RST =0;
  97   1              DelayXus(1);
  98   1              return(ucDa);
  99   1      }
 100          
 101          //=====================================================================//
 102          //      语法格式：      void DS1302_Set1302(uchar *pSecDa) 
 103          //      实现功能：      设置DS1302初始时间 
 104          //      参数：          uchar pSecDa――初始时间地址
 105          //      返回值：        无
 106          //=====================================================================//
 107          void DS1302_Set1302(uchar *pSecDa)
 108          {
 109   1              uchar i;
 110   1              uchar ucAddr=0x80; 
 111   1              DS1302_W1302(0x8e,0x00);  //写允许
 112   1              for(i=7;i>0;i--)
 113   1              { 
 114   2                      DS1302_W1302(ucAddr,*pSecDa); 
 115   2                      pSecDa++;
 116   2                      ucAddr+=2;
 117   2              }
C51 COMPILER V9.02   DS1302                                                                09/27/2019 09:57:41 PAGE 3   

 118   1              DS1302_W1302(0x8e,0x80); 
 119   1      }
 120          
 121          //=====================================================================//
 122          //      语法格式：      void DS1302_Get1302(uchar ucCurtime[]) 
 123          //      实现功能：      读取DS1302当前时间
 124          //      参数：          uchar ucCurtime――保存当前时间地址
 125          //      返回值：        无
 126          //=====================================================================//
 127          void DS1302_DA_TI(void)
 128          {
 129   1              uchar i;
 130   1              uchar tmp;
 131   1              uchar ucAddr=0x81;              
 132   1              for (i=0;i<7;i++)                                                               
 133   1              {
 134   2                      timenow[i]=DS1302_R1302(ucAddr);
 135   2                      ucAddr+=2;
 136   2              }
 137   1              get_DATA();
 138   1              get_TIME();
 139   1      } 
*** WARNING C280 IN LINE 130 OF DS1302.C: 'tmp': unreferenced local variable
 140          void    get_DATA()
 141          {
 142   1                      uchar tmp;
 143   1              uchar  high,low;
 144   1              uint year1,month1,day1;
 145   1      //      uchar str[]="DS16(10,100,'日期：2015-01-01',12);\r\n";
 146   1      
 147   1              tmp=timenow[6];                                 //取出年
 148   1      //      tmp=0x15;
 149   1              low=tmp&0x0f;                            
 150   1              high=(tmp&0xf0)>>4;
 151   1              year1=(uint)high*10+low;        
 152   1              if (year1<100)
 153   1                 {year=year1;
 154   2                 }            
 155   1      
 156   1              tmp=timenow[4];                                 //取出月
 157   1      //      tmp=0x02;
 158   1              low=tmp&0x0f;                           
 159   1              high=(tmp&0xf0)>>4;     
 160   1              month1=(uint)high*10+low;
 161   1              if (month1<13)
 162   1                 {month=month1;
 163   2                 }            
 164   1      
 165   1              tmp=timenow[3];                                 //取出日
 166   1      //      tmp=0x23;                                                               
 167   1              low=tmp&0x0f;                           
 168   1              high=(tmp&0xf0)>>4;             
 169   1          day1=(uint)high*10+low;
 170   1              if (day1<32)
 171   1                 {day=day1;
 172   2                 }    
 173   1              sprintf(SHOW_DA,"日期20%02d-%02d-%02d",year,month,day); 
 174   1              PutStr(1,0,SHOW_DA);                
 175   1          Delay1ms();
 176   1      }
 177          void    get_TIME()
 178          {
C51 COMPILER V9.02   DS1302                                                                09/27/2019 09:57:41 PAGE 4   

 179   1                      uchar tmp;
 180   1              uint  high,low;
 181   1              uint hour1,min1,sec1;
 182   1      
 183   1             tmp=timenow[2];                                  //取出时
 184   1                 low=tmp&0x0f;                                
 185   1                 high=(tmp&0xf0)>>4;                  
 186   1             hour1=high*10+low;
 187   1                 if (hour1<24)
 188   1                 {hour=hour1;
 189   2                 }
 190   1      
 191   1                 tmp=timenow[1];                                      //取出分                                                        
 192   1                 low=tmp&0x0f;                                
 193   1                 high=(tmp&0xf0)>>4;                  
 194   1                 min1=high*10+low;
 195   1                 if (min1<60)
 196   1                 {min=min1;
 197   2                 }
 198   1      
 199   1                 tmp=timenow[0];                                  //取出秒
 200   1      //         tmp=0x49;
 201   1                 low=tmp&0x0f;                                
 202   1                 high=(tmp&0xf0)>>4;          
 203   1                 sec1=high*10+low;
 204   1                 if (sec1<60)
 205   1                 {sec=sec1;
 206   2                 }
 207   1      
 208   1           sprintf(SHOW_TI,"时间%02d:%02d:%02d",hour,min,sec);
 209   1                PutStr(2,0,SHOW_TI);
 210   1               Delay1ms();
 211   1                       
 212   1      }
 213          void DS1302_Initial()
 214          {
 215   1          T_RST = 0;
 216   1          T_CLK = 0;
 217   1          DS1302_W1302(0x8e, 0x00);   //允许写操作
 218   1          DS1302_W1302(0x80, 0x00);   //时钟启动
 219   1          DS1302_W1302(0x90, 0x00);   //一个二极管＋4K电阻充电
 220   1          DS1302_W1302(0x8e, 0x80);   //写保护
 221   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    931    ----
   CONSTANT SIZE    =     40    ----
   XDATA SIZE       =     19      20
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
